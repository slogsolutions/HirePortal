pipeline {
    agent any

    stages {

        stage("Checkout Code") {
            steps {
                checkout scm
            }
        }

        stage("Build Docker Images") {
            steps {
                sh "docker build -t hireportal-server ./server"
                sh "docker build -t hireportal-client ./client"
            }
        }

        stage("Deploy to VPS with Rollback") {
            steps {
                sshagent(credentials: ['vps_ssh_key']) {

                    withCredentials([
                        string(credentialsId: 'SERVER_IP',   variable: 'SERVER_IP'),
                        string(credentialsId: 'SERVER_USER', variable: 'SERVER_USER'),
                        string(credentialsId: 'APP_DIR',     variable: 'APP_DIR'),
                        string(credentialsId: 'HEALTH_URL',  variable: 'HEALTH_URL')
                    ]) {

                        sh """
                        ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} '
                            set -e

                            mkdir -p ${APP_DIR}
                            cd ${APP_DIR}

                            echo "üì¶ Saving current state"
                            docker compose ps > previous_state.txt || true

                            docker compose down || true
                            rm -rf server client docker-compose.yml
                        '
                        """

                        sh """
                        scp -r server client docker-compose.yml \
                            ${SERVER_USER}@${SERVER_IP}:${APP_DIR}
                        """

                        sh """
                        ssh ${SERVER_USER}@${SERVER_IP} '
                            cd ${APP_DIR}

                            docker compose up -d --build
                            sleep 15

                            STATUS=\$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL})

                            if [ "\$STATUS" != "200" ]; then
                                echo "‚ùå Health check failed ‚Äì rollback"
                                docker compose down
                                docker compose up -d
                                exit 1
                            fi

                            echo " Deployment successful"
                        '
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            sh "docker system prune -af"
        }
    }
}
